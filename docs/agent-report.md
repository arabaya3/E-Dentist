# تقرير eDentist.AI Agent

## 1. نظرة عامة
- **الغرض:** وكيل ذكي (نصي + صوتي) لإدارة مواعيد عيادة الأسنان، الإجابة على الأسئلة الشائعة، وتنفيذ الإجراءات على تكاملات الـPMS/CRM.
- **التقنيات الأساسية:** React + TypeScript للواجهة، Google Gemini (Text & Live) لطبقة الذكاء، Prisma + PostgreSQL للبيانات، تكاملات PMS مكتوبة في Node/Express (setupProxy + server/*).
- **حالة اليوم:** يدعم مهام الحجز، الإلغاء، إعادة الجدولة، الاستفسارات العامة، المتابعة بعد الزيارة، وتذكيرات العناية؛ ويقدم تجارب صوتية عبر النموذج الحي ونصية عبر `ConversationManager`.

## 2. مكونات الوكيل
| الطبقة | الملفات الأبرز | الوصف |
|--------|----------------|-------|
| واجهة المستخدم | `src/components/simple-voice/VoiceAgentBootstrap.tsx`, `src/services/conversation_manager.ts`, `src/contexts/LiveAPIContext` | تشغيل الجلسة النصية/الصوتية، بث الحالة، إرسال التعليمات للنموذج. |
| الخدمات المساندة | `src/services/conversation_manager.ts`, `src/utils/language.ts` | تحليل المقاصد، استخراج الكيانات، تطبيق قوالب الرد، والاتصال بالـPMS/DB. |
| طبقة الخادم | `src/setupProxy.js`, `server/dbBookingIntegration.ts`, `server/pmsIntegration.ts` | API موحّد لتوليد التوكنات، تسجيل التحليلات، مزامنة الحجوزات، تحميل بيانات الوكيل. |
| البيانات | `prisma/schema.prisma`, `prisma/seed.ts`, جدول `clinic_content`، جدول `AgentPageConfig` | تعريف المخطط، التهيئة بالبيانات الافتراضية، وتخزين القوالب الخاصة بكل عيادة. |

## 3. تدفق المحادثة (ConversationManager)
1. **استقبال الرسالة:** `ingestUserMessage` يسجل الدور والنص في الحالة.
2. **تحليل النية والكيانات:** يستدعي Gemini مع `capture_clinic_entities` للحصول على intent + entities، مع تطبيع أسماء الخدمات/الأطباء.
3. **تحديث الحالة:** يتم دمج الكيانات المحفوظة لتبقى السياقات السابقة متاحة.
4. **توليد الرد:** `generateAssistantReply` يحدد اللغة، يطبق قواعد التحية، ثم:
   - يختار القالب المناسب (`booking.confirmed`, `follow_up.general`، إلخ).
   - يستدعي `fetchClinicContent` للحصول على نص القالب من قاعدة البيانات.
   - يحقن المتغيرات (`{{doctor_name}}`, `{{appointment_time}}`, ...).
   - إذا لزم الأمر يستدعي `createBookingViaDB` أو `updateBookingViaDB` إلخ لتنفيذ العملية في الـPMS.
5. **تسجيل الاستجابة:** يتم دفع الرد في سجل الجلسة ليستخدم كسياق للطلبات التالية.

## 4. التدفق الصوتي (VoiceAgentBootstrap)
- يحمل ضبط الوكيل من `/api/agent/config` والذي يعتمد على `AgentPageConfig` (الاسم، تحية عربية/إنجليزية، الحقول المطلوبة، اسم العيادة).
- يركّب `systemInstruction` داخل جلسة Gemini Live، مع قواعد ساعات العمل، متطلبات الحجز، ودعم الأداة `render_altair` لتصورات التحليلات عند الحاجة.
- يعتمد على نفس قاعدة البيانات لتحديد التحية الأولية ويعيد استخدام بيانات الوكيل النشطة.

## 5. الربط مع قاعدة البيانات
- **الحجوزات:** دوال `createBookingViaDB`, `updateBookingViaDB`, `cancelBookingViaDB` تترجم الطلب إلى سجلات `appointment` وتربطه بالطبيب/العيادة عبر `agentPageConfig` أو `user`.
- **توافر الأطباء:** `getAvailableDoctors` تجمع قائمة الأطباء النشطين من `agentPageConfig` أو مستخدمي العيادة.
- **قوالب العيادة:** تم إعادة تفعيل جدول `clinic_content` ويُستخدم الآن لأي ردود قابلة للتخصيص. يتم الاحتفاظ بالقيم الافتراضية (تحية الترحيب) داخل `AgentPageConfig` لاستخدامها كحل أخير فقط.

## 6. المشكلة التي تم حلّها
- **الأثر:** الوكيل كان يعيد ردودًا عامة لأن `fetchClinicContent` كانت تقرأ فقط من `AgentPageConfig` بعد إزالة جدول `clinic_content` في الهجرات السابقة، فغابت القوالب الخاصة بكل عيادة.
- **المعالجة:**
  1. أعدنا تعريف نموذج `ClinicContent` في `prisma/schema.prisma` مع مصفوفة كلمات مفتاحية ودعائم timestamps.
  2. أضفنا هجرة `20251112153000_create_clinic_content` لإنشاء الجدول + الفهارس.
  3. حسّنّا `fetchClinicContent` للاستعلام عن الجدول مع دعم اللغة الاحتياطية ثم الرجوع إلى تحيات `AgentPageConfig` فقط عند الضرورة.
  4. قمنا بتحديث `prisma/seed.ts` لملء عينات عربية/إنجليزية للحالات (`booking.confirmed`, `booking.missing_fields`, `follow_up.general`, ...).
  5. تم توثيق خطوات تهيئة الجدول داخل `README.md` تحت قسم "Clinic content templates".
- **النتيجة:** أي استجابة تنتقل الآن أولًا إلى بيانات العيادة المخزنة قبل اللجوء إلى نصوص عامة، ما يضمن اتساق الهوية اللفظية وروح العيادة في الردود.

## 7. طريقة تغذية القوالب
1. شغّل الهجرات والبذور:
   ```bash
   npx prisma migrate deploy
   npx prisma db seed
   ```
2. أضف/حدّث الصفوف في `clinic_content` (عبر Prisma Studio أو `psql`) مع الحقول:
   - `slug`: يطابق ما يرسله `ConversationManager` (مثال: `booking.confirmed`).
   - `locale`: `ar` أو `en`.
   - `content`: نص يدعم المتغيرات داخل أقواس مزدوجة (`{{doctor_name}}`).
   - `tags`: حقل معلوماتي للاستخدام المستقبلي (يمكن تركه فارغًا / `[]`).
3. لا حاجة لإعادة نشر الواجهة بعد تعديل القوالب؛ يتم جلبها لحظيًا من قاعدة البيانات.

## 8. توصيات ومهام تالية
1. **تشغيل اختبار محادثة:** `npm run demo:conversation` للتأكد من أن النصوص الجديدة تظهر بعد تحديث قاعدة البيانات.
2. **إضافة قوالب إضافية:** مثل `booking.failure_*`, `service.orthodontics` لضمان تغطية كاملة لكل intent.
3. **لوحة إدارة محتوى:** بناء صفحة بسيطة فوق `/api/agent/config` لإدارة `clinic_content` بدون تدخل مباشر في قاعدة البيانات.
4. **مراقبة الجودة:** إضافة تنبيهات إذا لم يُعثر على قالب لأي slug لتجنب العودة للصيغة العامة مستقبلًا.

> آخر تحديث: يعتمد هذا التقرير على الحالة بعد إصلاحات 12 نوفمبر 2025 (إعادة ربط الوكيل بقوالب قاعدة البيانات).
